{{ $current := . }}
<nav class="bd-links-nav w-100" aria-label="Docs navigation">
  {{ with .Site.GetPage "section" .Section }}
    {{ $sectionPages := (.Pages | append .) }}
    {{ range $sectionPages.ByWeight }}
      {{/* Determine page state with descriptive variable names */}}
      {{ $isCurrentPage := eq $current . }}
      {{ $isExpandableSection := and (eq $current.CurrentSection .) (ne .FirstSection .) }}
      {{ $shouldExpand := or $isCurrentPage $isExpandableSection }}
      {{ $sectionId := substr (sha1 .Permalink) 0 8 }}

      {{/* Check if this is an empty section page */}}
      {{ $isEmptySection := and .IsSection (eq (len .Content) 0) (gt (len .Pages) 0) }}
      {{ $shouldLink := not (or .Page.Params.nolink $isEmptySection) }}

      {{ if not .Page.Params.tocHidden }}
        <div class="section-container container pe-0 pt-1">
          {{/* Add expand/collapse controls for sections with children */}}
          {{ $hasChildren := and .IsSection (ne .FirstSection .) (gt (len .Pages) 0) }}

          <div
            class="container nav-container pe-0 d-flex w-100 {{ if $isCurrentPage }}active{{ else if $shouldExpand }}active-parent{{ end }}"
            {{ if $hasChildren }}
              data-bs-toggle="collapse"
              data-bs-target="#collapse-{{ $sectionId }}"
              aria-expanded="{{ if $shouldExpand }}true{{ else }}false{{ end }}"
              role="button"
              tabindex="0"
            {{ end }}
          >

            {{/* Render link or span based on content and nolink parameter */}}
            {{ if and $shouldLink (not $hasChildren) }}
              <a class="d-flex w-100 border-0" href="{{ .Permalink }}">{{ .Title }}</a>
            {{ else }}
              <span class="d-flex w-100 border-0">{{ .Title }}</span>
            {{ end }}

            {{ if $hasChildren }}
              <div class="d-flex flex-shrink-1 sidebar-control-container align-self-center">
                <input
                  type="checkbox"
                  class="d-flex sidebar-checkbox"
                  {{ if $shouldExpand }}checked{{ end }}
                  aria-label="Close or Expand {{ .Title }} Section"
                />
                <label class="sidebar-label {{ if not $shouldExpand }}collapsed{{ end }}">
                  <svg class="flex bi sidebar-icon plus">
                    <use xlink:href="#plus"></use>
                  </svg>
                  <svg class="flex bi sidebar-icon x">
                    <use xlink:href="#x"></use>
                  </svg>
                </label>
            </div>
            {{ end }}
          </div>

          {{/* Render child pages for non-root sections */}}
          {{ if ne .FirstSection . }}
            {{ range .Pages }}
              {{ if not .Page.Params.tocHidden }}
                <div
                  class="container flex-row collapse {{ if $shouldExpand }}show{{ end }}"
                  id="collapse-{{ $sectionId }}"
                >
                  <div class="d-flex flex-column">
                    <a
                      class="bd-links d-flex {{ if eq $current . }}active{{ end }}"
                      href="{{ .Permalink }}"
                    >
                      {{ .Title }}
                    </a>
                  </div>
                </div>
              {{ end }}
            {{ end }}
          {{ end }}
        </div>
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Include additional sidebar sections */}}
  {{ if not ($.Param "docs") }}
    {{ partialCached "sidebar/user-docs" . }}
  {{ end }}
  {{ if ne .Page.Params.product "Contributing Guide" }}
    {{ partialCached "sidebar/contributing-guide" . }}
  {{ end }}
  {{ partialCached "sidebar/roadmap" . }}
</nav>
