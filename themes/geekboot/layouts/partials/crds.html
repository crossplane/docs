<div class="crds container">

    <div class="row crd-header-row">
        <div class="col">Kind</div>
        <div class="col">Group</div>
        <div class="col">
            <div class="row">
                <div class="col">Version</div>
                <div class="col"><a href="#">Expand All</a></div>
                <div class="col"><a href="#">Collapse All</a></div>
            </div>
        </div>
    </div>

    {{/* Each level is a map with the key being the directory name */}}
    {{/* $Site.Data.crds /$version/crds/yaml */}}
    {{ range  $filename,$contents := index $.Site.Data.crds (printf "v%s" .Page.Params.version) "crds" "yaml" }}
        {{ $kind := .spec.names.kind }}
        {{ $group := .spec.group }}
        {{ $version := "" }}
        {{ $schema := (dict ) }}
        {{ $dataType := "" }}


        {{/* Iterate over each version and find the "storage: true" version */}}
        {{ range  .spec.versions }}
            {{ if index . "storage" }}
                {{ $version = .name }}
                {{ $schema = index . "schema" "openAPIV3Schema" }}
                {{ $dataType = $schema.type }}
            {{ end }}
        {{ end }}

        {{/* the crd-root-row is a top level CRD row */}}
        <div class="crd-root-row row">
            <div class="col">
                {{/* Plus/Minus Button */}}
                <button class="expand-button collapsed" data-bs-toggle="collapse" data-bs-target="#{{$kind}}" type="button" aria-expanded="false" aria-controls="{{$kind}}"></button>

                {{/* CRD name text */}}
                <button class="crd-root collapsed" data-bs-toggle="collapse" data-bs-target="#{{$kind}}" type="button" aria-expanded="false" aria-controls="{{$kind}}">
                    <span class="kind">{{ $kind }}</span>
                </button>
            </div>
            <div class="col">{{ $group }}</div>
            <div class="col">
                <div class="row">
                    <div class="col">{{ $version }}</div>
                    <div class="col"><a href="#">Expand All</a></div>
                    <div class="col"><a href="#">Collapse All</a></div>
                </div>
            </div>

            {{/* The container to show/hide with information related to the CRD */}}
            <div class="collapse crd-expand" id="{{$kind}}">
                <div class="description">
                    {{ $schema.description }}
                </div>
                <div class="crd-children">
                    {{ template "buildCRD" (dict "schema" $schema "isFirst" true "kind" $kind "requiredFields" $schema.properties.spec.required) }}
                </div>
            </div>
        </div>
    {{ end }}

</div>


{{ define "buildCRD" }}

    {{ $requiredFields := .requiredFields }}

    {{/* The first field (spec) has a different schema compared to the child nodes */}}
    {{ if .isFirst }}
        <div class="crd-child-container">
            {{/* Plus/Minus Button */}}
            <button class="expand-button collapsed" data-bs-toggle="collapse" data-bs-target="#{{.kind}}-spec" type="button" aria-expanded="false" aria-controls="{{.kind}}-spec"></button>

            {{/* CRD name text */}}
            <button class="crd-root collapsed" data-bs-toggle="collapse" data-bs-target="#{{.kind}}-spec" type="button" aria-expanded="false" aria-controls="{{.kind}}-spec">
                <div>
                    <span class="kind">spec</span>
                    <span class="dataType {{.schema.properties.spec.type }}">{{.schema.properties.spec.type }}</span>
                </div>
            </button>

            {{/* The container to show/hide with information related to the CRD */}}
            <div class="collapse crd-expand" id="{{.kind}}-spec">
                <div class="description">
                    {{ .schema.properties.spec.description | markdownify }}
                </div>
                <div class="crd-children">
                    {{ template "buildCRD" (dict "schema" .schema.properties.spec.properties "isFirst" false "kind" .kind "requiredFields" $requiredFields) }}
                </div>
            </div>
        </div>

    {{ else }}
        {{/* Iterate over all child CRD elements */}}
        {{ range $k,$v := .schema }}
            {{ $dataType := $v.type }}
            {{ $dataTypeStyle := $dataType }}

            {{ if eq $dataType "array" }}
                {{ $dataTypeStyle = $v.items.type }}
                {{ $dataType = (printf "[ ]%s" $v.items.type) }}
            {{ end }}

            <div class="crd-child-container">

                {{/* Plus/Minus Button */}}
                <button class="expand-button collapsed" data-bs-toggle="collapse" data-bs-target="#{{$k}}-{{.kind}}" type="button" aria-expanded="false" aria-controls="{{$k}}-{{.kind}}"></button>

                {{/* CRD name text */}}
                <button class="crd-root collapsed" data-bs-toggle="collapse" data-bs-target="#{{$k}}-{{.kind}}" type="button" aria-expanded="false" aria-controls="{{$k}}-{{.kind}}">
                    <div>
                        <span class="kind">{{ $k }}</span>
                        <span class="dataType {{ $dataTypeStyle }}">{{ $dataType }}</span>
                        {{if in $requiredFields $k}}<span class="dataType required">required</span>{{end }}
                    </div>
                </button>

                {{/* The container to show/hide with information related to the CRD */}}
                <div class="collapse crd-expand" id="{{$k}}-{{.kind}}">
                    <div class="description">
                        {{$v.description | markdownify }}
                    </div>
                    {{ if $v.properties }}
                        <div class="crd-children">
                            {{ template "buildCRD" (dict "schema" $v.properties "requiredFields" $v.required "kind" $k ) }}
                        </div>
                    {{ end }}
                </div>
            </div>
        {{ end }} {{/* range $k,$v */}}
    {{ end }} {{/* if/else */}}
{{ end }} {{/* define */}}


<script>

function sortIt(sortOn="kind"){

    var toSort = document.getElementById('crds').children;
    toSort = Array.prototype.slice.call(toSort, 0);

    toSort.sort(function(a, b) {
        var aord = a.dataset.sortOn;
        var bord = b.dataset.sortOn;

        return (aord.localeCompare(bord));
    });

    var parent = document.getElementById('crds');
    parent.innerHTML = "";

    for(var i = 0, l = toSort.length; i < l; i++) {
        parent.appendChild(toSort[i]);
    }
}
</script>