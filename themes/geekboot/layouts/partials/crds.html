{{ .Content }}

<div class="crds">

    <!-- Kind | Group | Version | Expand | Collapse header -->
    <div class="row crd-header-row bigName-row" id="crd-header-row">
        <div class="col col-xl-4 col-8 sortable" onclick="sortIt('kind')"><span data-sort="kind">Kind</span><span class="kind-sort sort-icon sort-icon-down d-none"></span><span class="kind-sort sort-icon sort-icon-up d-none"></span></div>
        <div class="col col-lg-4 mobile-hidden sortable" onclick="sortIt('group')"><span data-sort="group">Group/Version</span><span class="group-sort sort-icon sort-icon-down d-none"></span><span class="group-sort sort-icon sort-icon-up d-none"></span></div>
        <div class="col col-2 expand-link mobile-hidden text-truncate" onclick="showAll('all')"><a href="#">Expand All</a></div>
        <div class="col col-2 collapse-link mobile-hidden text-truncate" onclick="hideAll('all')"><a href="#">Collapse All</a></div>
    </div>
    <div>
        {{ $crdFiles := index $.Site.Data.crds .Section "api" "crds" }}
        {{ $descFiles := index $.Site.Data.crds .Section "api" "descriptions" }}


        {{ range $fileName, $crdContent := $crdFiles }}
            {{ $group   := $crdContent.spec.group }}
            {{ $kind    := $crdContent.spec.names.kind }}

            {{ $descDir := index $descFiles $group $kind }}
            {{ $description := $descDir.description.description }}

            {{/* Find the active version. We prefer the "storage: true" value but use "served: true" as a backup */}}
            {{ $versionAndSchema := partial "apiBuilder/getVersionAndSchema" $crdContent.spec }}
            {{ $schema := $versionAndSchema.schema.openAPIV3Schema }}

            {{ $version := $versionAndSchema.version }}
            {{ $type := $schema.type }}

            {{ $kind }} - {{ $version }} <br />
            {{ $description }}<br /><br />


            {{ partial "apiBuilder/processSpec" (dict "schema" $schema "requiredKeys" slice ) }}

            <hr/>


        {{ end}}


    <div>
    <div id="crd-rows-container">


    </div>

<script>

    function getCRDElements(type){

        if(type === "all"){
            var root = document;
        }
        else{
            var typeElem = document.querySelector(type);
            var root = typeElem.closest(".crd-container")
        }
        var buttons = root.querySelectorAll(".expand-buttons > button");
        var hiddenElems = root.querySelectorAll(".crd-expand");

        return {
            "buttons": buttons,
            "hiddenElems": hiddenElems
        }
    }

    /**
     * Add the "show" class and remove the "collapse" class from all elements
     * matching the 'type' queryselector.
     *
     * Alternatively the type `all` will apply to all elements.
     * @param {string} type - a CSS query selector or "all"
     */
    function showAll(type){

        var crdElements = getCRDElements(type);
        var buttons = crdElements["buttons"];
        var hiddenElems = crdElements["hiddenElems"];

        // This works by changing the classes bootstrap uses.
        // It would be more accurate to click() or invoke the bootstrap JS API.
        // This has major performance problems for large APIs and isn't used.
        for(var i = 0; i < buttons.length; i++){
            buttons[i].classList.remove("collapsed");
        }

        for(var i = 0; i < hiddenElems.length; i++){
            hiddenElems[i].classList.remove("collapse");
            hiddenElems[i].classList.add("show");
        }

    }

    /**
     * Add the "collapse" class and remove the "show" class from all elements
     * matching the 'type' queryselector.
     *
     * Alternatively the type `all` will apply to all elements.
     * @param {string} type - a CSS query selector or "all"
     */
    function hideAll(type){

        var crdElements = getCRDElements(type);
        var buttons = crdElements["buttons"];
        var hiddenElems = crdElements["hiddenElems"];

        // This works by changing the classes bootstrap uses.
        // It would be more accurate to click() or invoke the bootstrap JS API.
        // This has major performance problems for large APIs and isn't used.
        for(var i = 0; i < buttons.length; i++){
            buttons[i].classList.add("collapsed");
        }

        for(var i = 0; i < hiddenElems.length; i++){
            hiddenElems[i].classList.add("collapse");
            hiddenElems[i].classList.remove("show");
        }

    }

    /**
     * Sorts the API by 'kind', 'group' or 'version'.
     *
     * @param {string} sortOn - One of "kind", "group" or "version"
     */
    function sortIt(sortOn="kind"){

        // only look at elements labeled as "stortable"
        var titleElements = document.getElementsByClassName("sortable");

        // natural or reverse sort?
        var reverseSort = false;

        // iterate over the sortable items and set the proper sort icon
        for(var i = 0; i < titleElements.length; i++){
            if(titleElements[i].children[0].dataset.sort === sortOn){

                titleElements[i].classList.add("sorted");

                // If we can't see the first element then sort natural
                if(titleElements[i].children[1].classList.contains("d-none")){
                    titleElements[i].children[1].classList.remove("d-none");
                    titleElements[i].children[2].classList.add("d-none");
                }
                // Otherwise, the first element is visible and the second isn't.
                // Make it visible and reverse sort
                else if(titleElements[i].children[2].classList.contains("d-none")){
                    titleElements[i].children[2].classList.remove("d-none");
                    titleElements[i].children[1].classList.add("d-none");
                    reverseSort = true
                }
            }
            else {
                titleElements[i].classList.remove("sorted");
                titleElements[i].children[1].classList.add("d-none");
                titleElements[i].children[2].classList.add("d-none");
            }
        }

        // element sorting from https://jsfiddle.net/fkling/nXkDp/
        var toSort = document.getElementById('crd-rows-container').children;
        toSort = Array.prototype.slice.call(toSort, 0);

        toSort.sort(function(a, b) {
            var aord = a.dataset[sortOn];
            var bord = b.dataset[sortOn];

            if(reverseSort){
                return (bord.localeCompare(aord));
            }
            else {
                return (aord.localeCompare(bord));
            }
        });

        var parent = document.getElementById('crd-rows-container');
        parent.innerHTML = "";

        for(var i = 0, l = toSort.length; i < l; i++) {
            parent.appendChild(toSort[i]);
        }
    }

    // on page load sort the fields and expand and scroll to the anchor if it's set.
    document.addEventListener("DOMContentLoaded", function(event){
        sortIt();
        scrollToAnchor();
    })

    function scrollToAnchor(){
        var hash = window.location.hash.replace("#","");

        if(hash === "content"){
            return
        }

         // hash on this page means they linked directly to an API object
        if(hash.length > 0){

            var hashes = hash.split("-");

            // set an event listener on the last element to scroll it into view when expanded.
            var lastElement = document.getElementById(hash);
            lastElement.closest(".crd-child-container").classList.add("anchor-target");

            // loop through the parent elements and click them to expand
            var workingHash = [];
            for(var index = 0; index < hashes.length; index++){
                workingHash.push(hashes[index]);
                document.querySelector("#" + workingHash.join("-")).classList.add("show");
            }


        }
    }

    document.onLoad(showAll('.CompositeResourceDefinition'))
</script>